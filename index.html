<!DOCTYPE html>
<html>
<head>
    <meta charset=utf-8 />
    <title>A simple map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />
    <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute;
            top:65px;
            bottom:0;
            width:100%;
        }
        .marker {
            /*background-image: url('mapbox-icon.png');*/
            /*position: absolute;*/
            /*background-size: cover;*/
            width: 25px;
            height: 25px;
            border-radius: 50%;
            cursor: pointer;
            /*left: 0px;*/
        }

    </style>

</head>
<body>

<!--<div id="positionText"></div>-->
<!--<div class="marker em gun em-confused"></div>-->
<!--<i class="em em-confused"></i>-->

<div id='map' style='width: 800px; height: 700px;'></div>
<div id="positionText" style="margin: 10px">Coordinates</div>
<script src='config.js'></script>

<script>

    var changeSmileSide = ()=> {
        var el = document.querySelector('.em-confused');
        if (smileSide === 0) {
            document.querySelector('.em-confused').style.transform = "scale(-1, 1)";
            smileSide = 1;
        } else {
            document.querySelector('.em-confused').style.transform = "scale(1, 1)";
            smileSide = 0;
        };
    };


    var count = 0;
    var step = 0.00005;
    var smileSide = 0;
    var posText = document.getElementById("positionText");


    var removeEmoji = ()=> {
        var emojis = Array.from(document.querySelectorAll('.marker'));
        emojis.forEach( item => {
            item.parentNode.removeChild(item)
        } )
    }

    var geojsonGun = {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [36.386859, 49.926677]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'Gun'
                },
            }
        ]
    };

    var geojson = {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [36.383519, 49.926677]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'Enemy 1'
                },
            },
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [36.385621, 49.926692]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'Enemy 2'
                },
            },
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [36.387859, 49.926547]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'Enemy 3'
                },
            },
            {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [36.385203, 49.927737]
                },
                properties: {
                    title: 'Mapbox',
                    description: 'Enemy 4'
                },
            }
        ]
    };

    mapboxgl.accessToken = accessToken;
    var map = new mapboxgl.Map({
        container: 'map',
        style: mapboxStyle,
        center: [ 36.387679, 49.926662],
        zoom: 17
    });


    var moveMarkers = ()=>{
        count++;
        if(count < 50) step = 0.00005;
        if(count > 50) step = -0.00005;
        if(count === 100) count = 0;

        geojson.features[0].geometry.coordinates[0] += step;
        geojson.features[1].geometry.coordinates[0] += step;
        geojson.features[2].geometry.coordinates[0] -= step;
        geojson.features[3].geometry.coordinates[1] -= step;

        geojson.features.forEach((marker)=> {
            var el = document.createElement('div');
            el.className = 'marker em em-alien';
            new mapboxgl.Marker(el)
                .setLngLat(marker.geometry.coordinates)
                .addTo(map);
        });
    };

    var moveGun = ()=>{
        if (navigator.geolocation) {
            // Если пользователь разрешил, определяем его местоположение и обрабатываем полученное значение с помощью функции ShowPosition
            navigator.geolocation.getCurrentPosition(function(position) {
                geojsonGun.features[0].geometry.coordinates[0] = position.coords.longitude;
                geojsonGun.features[0].geometry.coordinates[1] = position.coords.latitude;
                var el = document.createElement('div');
                el.className = 'marker em em-confused';

                if (smileSide === 0) {
                    el.className = 'marker em em-confused';
                    smileSide = 1;
                } else {
                    el.className = 'marker em em-face_with_raised_eyebrow';
                    smileSide = 0;
                };

                new mapboxgl.Marker(el)
                    .setLngLat(geojsonGun.features[0].geometry.coordinates)
                    .addTo(map);

                posText.innerHTML = 'X: ' + geojsonGun.features[0].geometry.coordinates[0]
                    + "</br>" + 'Y: ' +  geojsonGun.features[0].geometry.coordinates[1];

            });
        } else {
            // Если нет, выводим сообщение об ошибке
            posText.innerHTML = "Этот браузер не может определять местоположение";
        }

    };

    setInterval( ()=>{
        removeEmoji();
        moveMarkers();
        moveGun();
        // changeSmileSide();
    }, 3000 )


</script>

</body>
</html>

